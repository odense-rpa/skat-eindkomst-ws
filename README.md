# Odk.BluePrism

This solution contains the proxy library project for SKAT / eIndkomst and a console application for testing, and some unittests.

## Odk.BluePrism.Skat

The client proxy is implemented in this project.

Is used for querying the service endpoint: 'IndkomstOplysningPersonHent'

The service returns all income data stored in SKAT / eIndkomst given a citizen SSN and a date-period.

The service is restricted to query income from 'Flexloenstilskud'-receiving citizens.

### Service proxy generation (before TIN):

The service proxy always needs to be manually generated by the svcutil tool from the command line.

The runtime framework for the proxy is WCF (Windows Communication Foundation)

Production:

`svcutil https://eksternwiki.skat.dk/services/prod/eIndkomst10/wsdl/IndkomstOplysningPersonHent.wsdl /out:EIndkomstProxy.cs /namespace:*,eindkomst.prod /syncOnly`

Demo/Test: 

`svcutil https://eksternwiki.skat.dk/services/demo/eIndkomst10/IndkomstOplysningPersonHent.wsdl /out:EIndkomstProxy.cs /namespace:*,eindkomst.demo /syncOnly`

NOTE:

When the proxy is generated, the System.ServiceModel.ServiceContractAttribute for the service' interface MUST have the attribute 'ProtectionLevel = System.Net.Security.ProtectionLevel.Sign' added.
This can only be done manually in code - if the proxy is re-generated from the tool, the attribute must be added again.   

`[System.ServiceModel.ServiceContractAttribute(
    Namespace="http://rep.oio.dk/skat.dk/eindkomst/", 
    ConfigurationName="eindkomst.prod.IndkomstOplysningPersonHentServicePortType", 
    ProtectionLevel = System.Net.Security.ProtectionLevel.Sign)
]`


## Configuration

All service configuration is in code. If needed a ServiceConfig object can be provided to the EIndkomst constructor.

` var sconfig = new ServiceConfig
 {
     AbonnementTypeKode = "...",
     AdgangFormaalTypeKode = "...",
     AbonnentTypeKode = "...",
     AuthenticationCert = "...",
     SigningCert = "...",
     DNSIdentity = "...",
     SENummer = "..."
 };`

 `EIndkomst e = new EIndkomst(sconfig);`


 ## Support of basismonth

 The proxy supports lookup of income from the start- and enddate as "Loenperiode". This the default. The proxy also supports lookup of income based on "ååååmd" (alså known as basismonth) based on the start- and enddate. 
 

 ## Deployment to Blue Prism

 Build the solution in Release configuration. Manually copy the assembly 'Odk.BluePrism.Skat.dll' to 'Blue Prism Automate'-folder on the Blue Prism Develop- or Worker instance.
